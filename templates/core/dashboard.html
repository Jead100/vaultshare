{% extends "base.html" %}
{% block title %} | Dashboard {% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Your Dashboard</h1>

    <!-- Upload Card -->
    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Upload a File</h2>
        <form enctype="multipart/form-data" id="upload-form" class="space-y-5">
            {% csrf_token %}

            <div class="flex items-center space-x-4">
                <!-- Upload / Choose File button -->
                <button type="button" id="action-btn"
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold
                        hover:bg-blue-600 hover:shadow-md transition duration-200 flex items-center justify-center gap-2">
                    Choose File
                </button>

                <!-- File label + clear button -->
                <div class="flex items-center space-x-2">
                    <span id="file-label" class="text-gray-600">No file chosen</span>
                    <button type="button" id="clear-file" class="text-gray-400 hover:text-red-500 hidden">&times;</button>
                </div>
            </div>

            <!-- Hidden actual file input -->
            {{ form.file }}
        </form>
    </div>

    <!-- Files List -->
    <div id="files-list" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Your Files</h2>
        {% include "_partials/_files_list.html" with files=files %}
    </div>

</div>

<!-- Script to handle file selection and delete action -->
<script>
    const fileInput = document.querySelector('input[type="file"]');
    const actionBtn = document.getElementById('action-btn');
    const fileLabel = document.getElementById('file-label');
    const clearBtn = document.getElementById('clear-file');
    const form = document.getElementById('upload-form');
    const filesList = document.getElementById('files-list');

    fileInput.classList.add("hidden");

    let fileSelected = false;
    let uploading = false;

    actionBtn.addEventListener('click', () => {
        if (!fileSelected) {
            fileInput.click();
        } else if (!uploading) {
            startUpload();
        }
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileSelected = true;
            fileLabel.textContent = this.files[0].name;
            clearBtn.classList.remove("hidden");
            setButtonState("upload");
        }
    });

    clearBtn.addEventListener('click', () => {
        resetSelection();
    });

    function setButtonState(state) {
        actionBtn.classList.remove("bg-blue-500", "hover:bg-blue-600", "bg-green-500", "hover:bg-green-600");
        actionBtn.innerHTML = "";

        if (state === "choose") {
            actionBtn.textContent = "Choose File";
            actionBtn.classList.add("bg-blue-500", "hover:bg-blue-600");
        }
        else if (state === "upload") {
            actionBtn.textContent = "Upload";
            actionBtn.classList.add("bg-green-500", "hover:bg-green-600");
        }
        else if (state === "loading") {
            actionBtn.classList.add("bg-gray-500");
            actionBtn.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
                    </path>
                </svg>
                Uploading...
            `;
        }
        else if (state === "success") {
            actionBtn.textContent = "Uploaded!";
            actionBtn.classList.add("bg-green-500");
        }
    }

    // Upload handler
    function startUpload() {
        uploading = true;
        setButtonState("loading");

        const formData = new FormData(form);

        fetch(form.getAttribute("action") || window.location.pathname, {
            method: "POST",
            headers: {
                "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value,
                "X-Requested-With": "XMLHttpRequest"
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                filesList.innerHTML = data.html;
                setButtonState("success");
                setTimeout(resetSelection, 1500);
            }
        })
        .catch(() => {
            alert("Upload failed. Please try again.");
            resetSelection();
        });
    }

    function resetSelection() {
        fileInput.value = "";
        fileSelected = false;
        uploading = false;
        fileLabel.textContent = "No file chosen";
        clearBtn.classList.add("hidden");
        setButtonState("choose");
    }

    // Delete handler
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-file')) {
            const fileId = e.target.getAttribute('data-file-id');
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/files/delete/${fileId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        filesList.innerHTML = data.html;
                    } else {
                        alert("Error deleting file.");
                    }
                })
                .catch(() => alert("Error deleting file."));
            }
        }
    });
</script>
{% endblock %}
